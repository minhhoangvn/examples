---
- name: Converge
  hosts: master-1
  gather_facts: true
  tasks:
    - name: "Include global tasks"
      include_role:
        name: "k8s"
    - name: Load variable file
      include_vars:
        dir: ../../vars
    - name: Get cluster info
      command: kubectl cluster-info
      register: kubectl
      changed_when: false
    - name: "Install httbin test service {{ item }}"
      command: "{{ item }}"
      register: kubectl
      changed_when: false
      loop:
        - kubectl apply -f templates/httpbin.yaml -n foo
        - kubectl apply -f templates/httpbin.yaml -n bar
        - kubectl apply -f templates/httpbin.yaml -n legacy
    - name: "Install sleep test service {{ item }}"
      command: "{{ item }}"
      register: kubectl
      changed_when: false
      loop:
        - kubectl apply -f "{{ playbook_dir }}/templates/sleep.yaml" -n foo
        - kubectl apply -f "{{ playbook_dir }}/templates/sleep.yaml" -n bar
        - kubectl apply -f "{{ playbook_dir }}/templates/sleep.yaml" -n legacy
