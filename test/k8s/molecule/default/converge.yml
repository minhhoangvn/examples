---
- name: Converge
  hosts: master-1
  gather_facts: true
  tasks:
    - name: "Include global tasks"
      include_role:
        name: "k8s"
    - name: Load variable file
      include_vars:
        dir: ../../vars

    # - name: Get cluster info
    #   command: kubectl cluster-info
    #   register: kubectl
    #   changed_when: false

    # - name: "Install httbin test service {{ item }}"
    #   command: "{{ item }}"
    #   register: kubectl
    #   changed_when: false
    #   loop:
    #     - kubectl apply -f "{{ playbook_dir }}/../../templates/httpbin.yaml" -n foo
    #     - kubectl apply -f "{{ playbook_dir }}/../../templates/httpbin.yaml" -n bar
    #     - kubectl apply -f "{{ playbook_dir }}/../../templates/httpbin.yaml" -n legacy

    # - name: "Install sleep test service {{ item }}"
    #   command: "{{ item }}"
    #   register: kubectl
    #   changed_when: false
    #   loop:
    #     - kubectl apply -f "{{ playbook_dir }}/../../templates/sleep.yaml" -n foo
    #     - kubectl apply -f "{{ playbook_dir }}/../../templates/sleep.yaml" -n bar
    #     - kubectl apply -f "{{ playbook_dir }}/../../templates/sleep.yaml" -n legacy

    - name: Render Keyfactor proxy deployment template
      set_fact:
        "{{ item }}": "{{ lookup('template', playbook_dir + '/../../templates/config/'+ item + '.yaml.j2') }}"
      with_items:
        - "proxycredentials"
        - "proxyconfig"

    - name: Check Keyfactor proxy credentials template
      copy:
        content: "{{ proxycredentials }}"
        dest: "{{ playbook_dir }}/../../templates/proxycredentials.yaml"
    - name: Check Keyfactor proxy config template
      copy:
        content: "{{ proxyconfig }}"
        dest: "{{ playbook_dir }}/../../templates/proxyconfig.yaml"
